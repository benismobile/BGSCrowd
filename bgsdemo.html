<html>
<head>
  <title>BGS Dip And Strike Demo</title>

    <script src="js/openlayers/OpenLayers.js" type="text/javascript"></script> 
    <script src="js/jquery-1.10.2.min.js" type="text/javascript"></script>
    <script src="js/jquery.mousewheel.js" type="text/javascript"></script>
    <script src="js/ContourRegion.js" type="text/javascript"></script>
                 
                 
             
 <style type="text/css">
        
        body {
            font-family: sans-serif;
        }
        
        p 
        {
            width: 95%;
        }
        
        a {
            text-decoration: none;
            color: black;
            font-weight: bold;
            font-size: 1.1em;
        }

        div.map{
            width: 35%;
        height:90%;
        float: left;
        

        }
        
       div.mapcanvas{
            width: 35%;
        height:90%;
        float: left;
        	
        }
    
        div.inspectcanvas{
    
           background-color:white;
            border:5px solid black;
            width:70px;
            height:70px;
            float: left;
            margin:2px;
        	
        }
        
         div.controlpanel{
        width: 10%;
        height:10%;
        float: left;
        	
        }
    
        div.inspectionlens {
            cursor:move;
            width:125px;
            height:125px;
            background-color:white;
            border:5px solid black;
            margin:2px;
            opacity:0.3;
            float:left ;
        }

        div.draggable {
        background-color:yellow;
        opacity:0.5;
        }

    
        
        div.docs{
        float: left;
        width: 15%;
    	padding: 10 10 10 10;
        }

    </style>

    </head>
    
    
    <body>

	
	<p><b>BGS Dip &amp; Strike Demo</b></p>

<div>
    <div class="map" id="map"></div>
    <div class="mapcanvas" id="mapcanvas"></div>
    <canvas class="inspectcanvas" id="inspectcanvas" width=75 height=75>
    </canvas>
</div>        
    
 <div id="controlpanel" class="controlpanel">
            <br/>
            <label for="maxThreshold">Max Threshold</label>
            <input id="maxThreshold" type="range" name="maxThreshold" step="1" min="0" max="255" value="200" onchange="thresholdSlider('maxThresholdTxt', this.value)"/>
            <input id="maxThresholdTxt" type="text" value="200" disabled/> 
            
            <label for="minRoundness">Min Roundness</label>
            <input id="minRoundness" type="range" name="minRoundness" step="0.05" min="0" max="1" value="0" onchange="changeSlider('minRoundTxt', this.value)"/>          
            <input id="minRoundTxt" type="text" value="0.0" disabled/> 
            <label for="maxRoundness">Max Roundness</label>
            <input id="maxRoundness" type="range" name="maxRoundness" step="0.05" min="0" max="1" value="0.7" onchange="changeSlider('maxRoundTxt', this.value)"/>          
            <input id="maxRoundTxt" type="text" value="0.7" disabled/>
          
            <label for="minRegionSize">Min Region Size</label>
            <input id="minRegionSize" type="range" name="minRegionSize" step="5" min="0" max="2000" value="25" onchange="changeSlider('minRegionTxt', this.value)"/>          
            <input id="minRegionTxt" type="text" value="25" disabled/>
            <label for="maxRegionSize">Max Region Size</label>
            <input id="maxRegionSize" type="range" name="maxRegionSize" step="5" min="0" max="2000" value="550" onchange="changeSlider('maxRegionTxt', this.value)"/>          
            <input id="maxRegionTxt" type="text" value="550" disabled/>
            
            <label for="minEccentricity">min Eccentricity</label>      
            <input id="minEccentricity" type="range" name="minEccentricity" step="0.5" min="0" max="50" value="4.5" onchange="changeSlider('minEccentricityTxt', this.value)"/>          
            <input id="minEccentricityTxt" type="text" value="25" disabled/>
            <label for="maxEccentricity">max Eccentricity</label>
            <input id="maxEccentricity" type="range" name="maxEccentricity" step="0.5" min="0" max="5000" value="50" onchange="changeSlider('maxEccentricityTxt', this.value)"/>          
            <input id="maxEccentricityTxt" type="text" value="5000" disabled/>
            
            
<!--
 var filterParams =  {"minRegionSize":25 , "maxRegionSize":550 , "minRoundness":0 , "maxRoundness":0.7, "minEccentricity":4.5, "maxEccentricity":50 } ;
 -->
         </div>

   <div class="inspectionlens" id="inspectionlens"></div>

<script type="text/javascript">

// var minRoundness = 0.0 ;
// var maxRoundness = 0.7 ;

var changeSlider = function(eleStr, newval)
{

    var txtEle = document.getElementById(eleStr) ;
    txtEle.value = newval ;
    
    
}


var thresholdSlider = function(eleStr, newval)
{

    var txtEle = document.getElementById(eleStr) ;
    txtEle.value = newval ;
    
        var inspectCanvas = document.getElementById("inspectcanvas") ;
        var inspectCtx = inspectCanvas.getContext("2d") ;
     
       
       
        var lens = document.getElementById("inspectionlens") ;
        var mapCanvas = document.getElementById("mapcvs") ;
        
        
        $thresholdMax = newval
        
        
         var inspcanvs = new InspectCanvas(inspectCanvas ) ;
      inspcanvs.copyDataFromLens(lens, mapCanvas) ;
       inspcanvs.greyscale() ;
         
       var hist = inspcanvs.getGreyscaleHistogram() ;
      
       inspcanvs.threshold($thresholdMax) ;
     
       inspcanvs.invert() ;
       
      
       var contourTracer = new ContourTracer(inspectCanvas) ;
        contourTracer.findAllContours() ;
        contourTracer.collectRegions() ;
        var regions =  contourTracer.getBinaryRegions() ;
        
         var minRoundness = document.getElementById("minRoundness").value ;
        var maxRoundness = document.getElementById("maxRoundness").value ;
        var minRegionSize = document.getElementById("minRegionSize").value ;
        var maxRegionSize = document.getElementById("maxRegionSize").value ;
        var minEccentricity = document.getElementById("minEccentricity").value ;
        var maxEccentricity = document.getElementById("maxEccentricity").value ;
        
        var filterParams =  {"minRegionSize":minRegionSize , "maxRegionSize":maxRegionSize , "minRoundness":minRoundness , "maxRoundness":maxRoundness, "minEccentricity":minEccentricity, "maxEccentricity":maxEccentricity } ;
        // var filterParams =  {"minRegionSize":25 , "maxRegionSize":550 , "minRoundness":0 , "maxRoundness":0.7, "minEccentricity":minEccentricity, "maxEccentricity":maxEccentricity } ;
        inspcanvs.filterRegions(regions, filterParams) ;
    
}

// Jquery to handle dragging see http://jsfiddle.net/tovic/Jge9z/31/
$(document).ready(function() {
    var $dragging = null;
    var $mapCanvas = null ;        
    var $ctx =  null ;
    var $imageData ;
    var $thresholdMax = 0 ;
    

 //mousewheel increases and decrements dimensions of inspection lens 
    $('#inspectionlens').bind('mousewheel', function(event, delta, deltaX, deltaY) {

    var lens = document.getElementById("inspectionlens") ;
    
    if( lens.style.width == "")
    {
        lens.style.width = lens.clientWidth ;
        lens.style.height = lens.clientHeight ;
        
    }
    
     var lenw =     parseInt(lens.style.width.slice(0, lens.style.width.indexOf("px"))) + ( deltaY * 5) ;
     var lenh =   parseInt(lens.style.width.slice(0, lens.style.width.indexOf("px"))) + (deltaY * 5);
    lens.style.width = lenw + "px" ;
    lens.style.height = lenh + "px" ;

    
});
 
 // mousewheel changes thresholdMax and redraws inspection canvas
    $('#inspectcanvas').bind('mousewheel', function(event, delta, deltaX, deltaY) {
    
        var inspectCanvas = document.getElementById("inspectcanvas") ;
        var inspectCtx = inspectCanvas.getContext("2d") ;
     
        
         var lens = document.getElementById("inspectionlens") ;
        $thresholdMax = $thresholdMax  + (5*deltaY) ;
        
        document.getElementById("maxThreshold").value = $thresholdMax ;
        document.getElementById("maxThresholdTxt").value = $thresholdMax ;
        
         var inspcanvs = new InspectCanvas(inspectCanvas ) ;
       inspcanvs.copyDataFromLens(lens, $mapCanvas) ;
       inspcanvs.greyscale() ;
         
       var hist = inspcanvs.getGreyscaleHistogram() ;
      
       inspcanvs.threshold($thresholdMax) ;
     
       inspcanvs.invert() ;
      
       
       var contourTracer = new ContourTracer(inspectCanvas) ;
        contourTracer.findAllContours() ;
        contourTracer.collectRegions() ;
        var regions =  contourTracer.getBinaryRegions() ;
        
         var minRoundness = document.getElementById("minRoundness").value ;
        var maxRoundness = document.getElementById("maxRoundness").value ;
        var minRegionSize = document.getElementById("minRegionSize").value ;
        var maxRegionSize = document.getElementById("maxRegionSize").value ;
        var minEccentricity = document.getElementById("minEccentricity").value ;
        var maxEccentricity = document.getElementById("maxEccentricity").value ;
        
        var filterParams =  {"minRegionSize":minRegionSize , "maxRegionSize":maxRegionSize , "minRoundness":minRoundness , "maxRoundness":maxRoundness, "minEccentricity":minEccentricity, "maxEccentricity":maxEccentricity } ;
        // var filterParams =  {"minRegionSize":25 , "maxRegionSize":550 , "minRoundness":0 , "maxRoundness":0.7, "minEccentricity":minEccentricity, "maxEccentricity":maxEccentricity } ;
        inspcanvs.filterRegions(regions, filterParams) ;
        
        
    });
 
    var drawMode = false ;
 
    $('body').on("mousedown", "canvas.inspectcanvas", function(e) {
     
     drawMode = true ;
   });
 
    $('body').on("mouseup", "canvas.inspectcanvas", function(e) {
     
     drawMode = false ;
       var inspectCanvas = document.getElementById("inspectcanvas") ;
       
        var inspectCtx = inspectCanvas.getContext("2d") ;
        
    
    
    /*
       inspcdata = inspectCtx.getImageData(0,0,inspectCanvas.width, inspectCanvas.height) ;
       
        var d = inspcdata.data;
            
        for (var i=0; i<d.length; i+=4) {
        
            if(d[i+1] < 255 && d[i+1] > 0 )
            {
            if( d[i] == 255 && d[i+1] == 192 && d[i+2] == 203)
            {
                d[i] = 0 ;
                d[i+1]  = 0 ;
                d[i+2] = 0 ;
           }
            }           
        }
         inspectCtx.putImageData(inspcdata, 0, 0);
      */
      
     var contourTracer = new ContourTracer(inspectCanvas) ;
        contourTracer.findAllContours() ;
        contourTracer.collectRegions() ;
        var regions =  contourTracer.getBinaryRegions() ;
        
         var minRoundness = document.getElementById("minRoundness").value ;
        var maxRoundness = document.getElementById("maxRoundness").value ;
        var minRegionSize = document.getElementById("minRegionSize").value ;
        var maxRegionSize = document.getElementById("maxRegionSize").value ;
        var minEccentricity = document.getElementById("minEccentricity").value ;
        var maxEccentricity = document.getElementById("maxEccentricity").value ;
        
        var inspcanvs = new InspectCanvas(inspectCanvas ) ;
        var filterParams =  {"minRegionSize":minRegionSize , "maxRegionSize":maxRegionSize , "minRoundness":minRoundness , "maxRoundness":maxRoundness, "minEccentricity":minEccentricity, "maxEccentricity":maxEccentricity } ;
        // var filterParams =  {"minRegionSize":25 , "maxRegionSize":550 , "minRoundness":0 , "maxRoundness":0.7, "minEccentricity":minEccentricity, "maxEccentricity":maxEccentricity } ;
        inspcanvs.filterRegions(regions, filterParams) ;
     
     
   });
    
    $('body').on("mousemove", "canvas.inspectcanvas", function(e) {
     
        if(drawMode)
        {
            
            var inspectCanvas = document.getElementById("inspectcanvas") ;
            var inspectCtx = inspectCanvas.getContext("2d") ;
            inspectCtx.fillStyle = "black" ;
            inspectCtx.fillRect(e.pageX - inspectCanvas.offsetLeft, e.pageY - inspectCanvas.offsetTop , 3,3) ;
        }
                 
   });
    
    $('body').on("mousedown", "div.inspectionlens", function(e) {
        $(this).attr('unselectable', 'on').addClass('draggable');
        var el_w = $('.draggable').outerWidth(),
            el_h = $('.draggable').outerHeight();
        $('body').on("mousemove", function(e) {
            if ($dragging) {
                $dragging.offset({
                    top: e.pageY - el_h / 2,
                    left: e.pageX - el_w / 2
                
                });
            
            }
        });
    
        $dragging = $(e.target);
    
    }).on("mouseup", ".draggable", function(e) {
  
        $dragging = null;
        var el_w = $('.draggable').outerWidth(),
         el_h = $('.draggable').outerHeight();
        $(this).removeAttr('unselectable').removeClass('draggable');
    
       if($mapCanvas==null)
        {
            $mapCanvas = document.getElementById("mapcvs") ;
            $ctx  = $mapCanvas.getContext("2d") ;
        }
        
      
        var lens = document.getElementById("inspectionlens") ;
        var inspectCanvas = document.getElementById("inspectcanvas") ;
       var inspectCanvasCtx =  inspectCanvas.getContext("2d")  ;
        
        
       var inspcanvs = new InspectCanvas(inspectCanvas ) ;
       inspcanvs.copyDataFromLens(lens, $mapCanvas) ;
       inspcanvs.greyscale() ;
         
       var hist = inspcanvs.getGreyscaleHistogram() ;
    
       $thresholdMax = entropySplit(hist) ;
       document.getElementById("maxThreshold").value = $thresholdMax ;
       document.getElementById("maxThresholdTxt").value = $thresholdMax ;
        
     
       inspcanvs.threshold($thresholdMax) ;
     
       inspcanvs.invert() ;
       
       
       
        var contourTracer = new ContourTracer(inspectCanvas) ;
        contourTracer.findAllContours() ;
        contourTracer.collectRegions() ;
        var regions =  contourTracer.getBinaryRegions() ;
        
        
        var minRoundness = document.getElementById("minRoundness").value ;
        var maxRoundness = document.getElementById("maxRoundness").value ;
        var minRegionSize = document.getElementById("minRegionSize").value ;
        var maxRegionSize = document.getElementById("maxRegionSize").value ;
        var minEccentricity = document.getElementById("minEccentricity").value ;
        var maxEccentricity = document.getElementById("maxEccentricity").value ;
    
        
        var filterParams =  {"minRegionSize":minRegionSize , "maxRegionSize":maxRegionSize , "minRoundness":minRoundness , "maxRoundness":maxRoundness, "minEccentricity":minEccentricity, "maxEccentricity":maxEccentricity } ;
        inspcanvs.filterRegions(regions, filterParams) ;

        
          
    }); // ends mouseup event
    
    
    
    
}); //onready event


var InspectCanvas = function(inspectcanvas){
    
    var inspectCanvas = inspectcanvas ;
    var inspectWidth = 75 ;
    inspectHeight = 75 ;
    var filterRegions = [] ;
    
    this.copyDataFromLens = function(inspectlens, canvas) 
    {
        var lens = inspectlens ;
        var mapCanvas = canvas ;

        inspectWidth = lens.clientWidth ;
        inspectHeight = lens.clientHeight ;
        

        var ctx  = mapCanvas.getContext("2d") ;
        var imgData = ctx.getImageData(lens.offsetLeft - mapCanvas.offsetLeft , lens.offsetTop - mapCanvas.offsetTop, inspectWidth, inspectHeight ) ;
        
        inspectCanvas.width = inspectWidth ;
        inspectCanvas.height = inspectHeight ;
        var inspectCanvasCtx = inspectCanvas.getContext("2d") ;
        inspectCanvasCtx.putImageData(imgData, 0 , 0) ;
        
    };
    
    this.greyscale = function (){
        greyscale(inspectCanvas, 0, 0 , inspectWidth, inspectHeight) ;
    };
    
    this.threshold = function(thresholdMax)
    {
        threshold(inspectCanvas, 0 , 0, inspectWidth, inspectHeight, thresholdMax) ;   
    };
    
    this.getGreyscaleHistogram = function()
    {
    
      return getGreyscaleHistogram(inspectCanvas, 0 , 0, inspectWidth, inspectHeight) ;
    
    };
    
    this.invert = function (){
      
        invert(inspectCanvas, 0, 0 , inspectWidth, inspectHeight) ;  
        
    };
    
    //TODO    // blackPercentThreshold($inspectCanvas, 0, 0 , inspectWidth, inspectHeight, 0.8) ;
      
      
      
     this.filterRegions = function(regions, filterParams)
     {
        
        
            var minRegionSize = 25 ;
            var maxRegionSize = 2000 ;
            var minRoundness = 0 ;
            var maxRoundness = 1 ;
            var minEccentricity = 0 ;
            var maxEccentricity = 1000 ;
            
        
            if(filterParams != null)
            {
                minRegionSize = filterParams.minRegionSize == null ? 25 : filterParams.minRegionSize ;
                maxRegionSize = filterParams.maxRegionSize == null ? 2000 : filterParams.maxRegionSize ;
                minRoundness = filterParams.minRoundness == null ? 0 : filterParams.minRoundness ;
                maxRoundness = filterParams.maxRoundness == null ? 0 : filterParams.maxRoundness ;
                maxEccentricity = filterParams.maxEccentricity == null ? 0 : filterParams.maxEccentricity ;
                minEccentricity = filterParams.minEccentricity == null ? 0 : filterParams.minEccentricity ;
            }
        
             var inspectCanvasCtx = inspectCanvas.getContext("2d") ;    
            
            for( i = 0 ; i < regions.length ; i++)
                {
                     var regionSize = 0 ;
                     var perimSize = 0 ;
                     var roundness = 0 ;
                     var eccentricity = 0 ;
                     var bbox = regions[i].getBoundingBox() ;
                     
                    
                        regionSize = regions[i].getSize() ;
                      if (regionSize > minRegionSize && regionSize < maxRegionSize) 
                      {
                        perimSize = regions[i].perimeterContour.points.length ;
                        roundness =  (4 * Math.PI)  * ( regionSize / Math.pow(perimSize,2) )  ;
                        
                         var u20 =  centralMoment(inspectCanvas, bbox.left, bbox.top, bbox.width, bbox.height, 2, 0); 
                         var u02 =  centralMoment(inspectCanvas, bbox.left, bbox.top, bbox.width, bbox.height, 0, 2); 
                         var u11 =  centralMoment(inspectCanvas, bbox.left, bbox.top, bbox.width, bbox.height, 1, 1); 
                         var sqDiff2 = Math.pow((u20-u02), 2) ;
                         var sum2 = u20 + u02 ;
                         var sq4u11 = Math.pow(u11, 2) * 4 ;
                             
                         eccentricity = (sum2 + Math.sqrt(sqDiff2 + sq4u11)) /  (sum2 - Math.sqrt(sqDiff2 + sq4u11)) ;
                         
                         
                      }
                        
                    
                    if(regionSize > minRegionSize && regionSize < maxRegionSize && roundness > minRoundness && roundness < maxRoundness && eccentricity > minEccentricity &&  eccentricity < maxEccentricity )
                    {
                
                        inspectCanvasCtx.strokeStyle =  'rgb(255,192,203)';
                        
                        inspectCanvasCtx.beginPath();
                        inspectCanvasCtx.moveTo(bbox.left -1, bbox.top -1) ;
                        inspectCanvasCtx.lineTo(bbox.left -1 , bbox.top + bbox.height + 1) ;
                        inspectCanvasCtx.lineTo(bbox.left + bbox.width + 1, bbox.top  + 1 + bbox.height) ;
                        inspectCanvasCtx.lineTo(bbox.left + bbox.width + 1 , bbox.top -1 ) ;
                        inspectCanvasCtx.lineTo(bbox.left -1 ,  bbox.top - 1 ) ;
                        inspectCanvasCtx.stroke();
                        var rCenter = regions[i].getCenter() ;
                        
                   
                        var m00 = moment(inspectCanvas, bbox.left, bbox.top, bbox.width, bbox.height, 0, 0); // region area
                        var xCtr = moment(inspectCanvas,bbox.left, bbox.top, bbox.width, bbox.height, 1, 0) / m00;
                        var yCtr = moment(inspectCanvas,bbox.left, bbox.top, bbox.width, bbox.height, 0, 1) / m00;
                        var angle = orientation(inspectCanvas,bbox.left, bbox.top, bbox.width, bbox.height ) ;
                        var degrees = angle * 180 / Math.PI ;
                         
                        
                         inspectCanvasCtx.beginPath();
                        inspectCanvasCtx.arc( bbox.left  + xCtr, bbox.top + yCtr, 3, 0, 2 * Math.PI, false);
                        inspectCanvasCtx.fillStyle = 'red';
                        inspectCanvasCtx.fill();
                        inspectCanvasCtx.stroke();
                        
                        if(filterRegions.length == 0)
                        {
                            filterRegions[0] = regions[i] ;
                        }
                        else
                        {
                            filterRegions[filterRegions.length -1] = regions[i] ;
                        }
                    }
                    
                 
                }
           
     }
    
};


/**
* Map with local storage caching.
* @params options:
*     serviceVersion - TMS service version
*     layerName      - TMS layer name
*     type           - layer type
*     isBaseLayer    - is this the base layer?
*     name         - map name
*     url            - TMS URL
*     opacity        - overlay transparency
*/

 
   
  var MapWithLocalStorage = OpenLayers.Class(OpenLayers.Layer.TMS, {
  
  initialize: function(options) {

       this.serviceVersion = options.serviceVersion;
       this.layername = options.layerName;
       this.type = options.type;

       this.async = true;

       this.isBaseLayer = options.isBaseLayer;

       if(options.opacity){
           this.opacity = options.opacity;
       }

       OpenLayers.Layer.TMS.prototype.initialize.apply(this, [options.name,
                                                              options.url,
                                                              options]
                                                      );
   },
   
   getURLasync: function(bounds, callback, scope) {
       var urlData = this.getUrlWithXYZ(bounds);
       
        var pathname = window.location.pathname ;
  var n=pathname.lastIndexOf("bgsdemo.html");
  var cachepath = pathname.substring(0,n) ;
  callback.call(scope, cachepath + "/cache/" + urlData.z + "_" + urlData.x + "_" + urlData.y + "." + this.type  );

        
       
   },
   getUrlWithXYZ: function(bounds){
          bounds = this.adjustBounds(bounds);
       var res = this.map.getResolution();
       var x = Math.round((bounds.left - this.tileOrigin.lon) / (res * this.tileSize.w));
       var y = Math.round((bounds.bottom - this.tileOrigin.lat) / (res * this.tileSize.h));
       var z = this.serverResolutions != null ?
           OpenLayers.Util.indexOf(this.serverResolutions, res) :
           this.map.getZoom() + this.zoomOffset;

       //inverty for openstreetmap rather than google style TMS
      // var ymax = 1 << z;
      // var y = ymax - y -1;
       var path = this.serviceVersion + "/" + this.layername + "/" + z + "/" + x + "/" + y + "." + this.type;

       var url = this.url;
       if (OpenLayers.Util.isArray(url)) {
           url = this.selectUrl(path, url);
       }
       return { url: url + path, x:x, y:y, z:z};

   },
   getURL: function(bounds) {
       return "file:///./cache/" ;
   },
});



	var bounds = new OpenLayers.Bounds (0, 0, 700000, 1300000);


	var map = new OpenLayers.Map('map',  {controls: [], projection: new OpenLayers.Projection("EPSG:27700"), units: "m", maxExtent: bounds, resolutions: [1024,512,256,128,64,32,16,8,4,2,1]});

   

	map.addControl(new OpenLayers.Control.Navigation());
	map.addControl(new OpenLayers.Control.LayerSwitcher());
	map.addControl(new OpenLayers.Control.PanZoomBar());
	map.addControl(new OpenLayers.Control.Scale());
    var canvasDiv = null ;
    var mapcanvasDiv = null ;

    var fieldtripgb = new OpenLayers.Layer.TMS("cloud", "http://dlib-rainbow.edina.ac.uk/mapcache/tms", { layername: "fieldtripgb@BNG", type: "png", serverResolutions:[1024,512,256,128,64,32,16,8,4,2,1], tileOptions:
        {crossOriginKeyword:'annonymous'} } ) ;
   // could be worth tile options lsitener?

    var fieldtripgb_stack = new MapWithLocalStorage(  { layerName:"fieldtripgb", isBaseLayer:true, serviceVersion:"1.0.0", name:"tms" , url:"http://fieldtripgb.edina.ac.uk/", type: "png" }); 
     
     
      
      fieldtripgb.events.register("loadend", fieldtripgb_stack, function(fieldtripgb_stack)
      {
          
            if(mapcanvasDiv == null)
                 {
                      
                    canvasDiv = document.createElement("canvas") ;
                    canvasDiv.id = "mapcvs"
                    mapcanvasDiv = document.getElementById("mapcanvas") ;
                    
                    mapDiv = document.getElementById("map") ;
                    
                    mapcanvasDiv.appendChild(canvasDiv) ;
                 
                     //canvasDiv.style.width = tileImgParent.style.width ;
                     canvasDiv.width = mapDiv.clientWidth ;
                     canvasDiv.height = mapDiv.clientHeight ;
                     
                 }
          
          
        var mapCanvas = document.getElementById("mapcvs" ) ;
           var mapContainer = document.getElementById("OpenLayers.Map_2_OpenLayers_Container") ;
           
           
        
           
           if(mapCanvas !== null)
           {
                var ctx = mapCanvas.getContext("2d") ;
            
                var layers = document.getElementsByClassName("olLayerDiv") ;
                
                // ignore base layer but redraw other layers on canvas
                for(var i = 0 ; i < layers.length ; i++)
                {
        
                    var layertiles = layers[i].getElementsByClassName("olTileImage") ;
                    for(var j = 0 ; j < layertiles.length ; j++ )
                    {
                        var tileImg = layertiles[j]  ;
               
                        var clientLeft = tileImg.offsetLeft;
                        var offsetLeft = tileImg.offsetLeft;
                        var offsetTop = tileImg.offsetTop ;
           
                    
                    
                        var left = Number(mapContainer.style.left.slice(0, mapContainer.style.left.indexOf("p"))) ;
                        var top = Number(mapContainer.style.top.slice(0, mapContainer.style.top.indexOf("p")))
                        ctx.drawImage(tileImg, offsetLeft + left, offsetTop + top) ;
                
                    }
               
                }
           }
          
          
          
      });
      
       map.events.register("moveend", map , function(map)
       {
           
           var mapCanvas = document.getElementById("mapcvs" ) ;
           var mapContainer = document.getElementById("OpenLayers.Map_2_OpenLayers_Container") ;
           
           
        
           
           if(mapCanvas !== null)
           {
                var ctx = mapCanvas.getContext("2d") ;
            
                var layers = document.getElementsByClassName("olLayerDiv") ;
                
                for(var i = 0 ; i < layers.length ; i++)
                {
        
                    var layertiles = layers[i].getElementsByClassName("olTileImage") ;
                    for(var j = 0 ; j < layertiles.length ; j++ )
                    {
                        var tileImg = layertiles[j]  ;
               
                        var clientLeft = tileImg.offsetLeft;
                        var offsetLeft = tileImg.offsetLeft;
                        var offsetTop = tileImg.offsetTop ;
           
                    
                    
                        var left = Number(mapContainer.style.left.slice(0, mapContainer.style.left.indexOf("p"))) ;
                        var top = Number(mapContainer.style.top.slice(0, mapContainer.style.top.indexOf("p")))
                        ctx.drawImage(tileImg, offsetLeft + left, offsetTop + top) ;
                
                    }
               
                }
           }
       });
       
       
       var arranwms = new OpenLayers.Layer.WMS("wms","http://129.215.193.137:8090/cgi-bin/mapserv62.fcgi?", 
       { map: 'mapfiles/arran.map',layers: 'arran',  transparent: 'true'}, {resolutions:[1024,512,256,128,64,32,16,8,4,2,1], tileOptions:
        {crossOriginKeyword:'annonymous'}, visibility: true }  );
       
       var  torquaywms = new OpenLayers.Layer.WMS("torquaywms","http://129.215.193.137:8090/cgi-bin/mapserv62.fcgi?", 
       { map: 'mapfiles/torquay.map',layers: 'torquay',  transparent: 'true'}, {resolutions:[1024,512,256,128,64,32,16,8,4,2,1], tileOptions:
        {crossOriginKeyword:'annonymous'}, visibility: true }  );

       
       map.addLayers([fieldtripgb, arranwms, torquaywms]);

       map.zoomToMaxExtent();

      </script>

</body>
</html>
